<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>YU</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="YU">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="YU">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="YU" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">YU</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Think of Wind.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-ThreadPoolExecutor的四种拒绝策略" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2023/03/23/ThreadPoolExecutor%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%8B%92%E7%BB%9D%E7%AD%96%E7%95%A5/" class="article-date">
  <time datetime="2023-03-23T02:38:53.000Z" itemprop="datePublished">2023-03-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/03/23/ThreadPoolExecutor%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%8B%92%E7%BB%9D%E7%AD%96%E7%95%A5/">ThreadPoolExecutor的四种拒绝策略</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="ThreadPoolExecutor介绍"><a href="#ThreadPoolExecutor介绍" class="headerlink" title="ThreadPoolExecutor介绍"></a><strong>ThreadPoolExecutor介绍</strong></h2><p>Java 提供的线程池相关的工具类中，最核心的是 ThreadPoolExecutor，我们先了解一下线程池默认的工作行为。</p>
<ul>
<li>不会初始化核心线程（可定义），而是有任务来了才创建工作线程；</li>
<li>当核心线程满了之后不会立即扩容线程池，而是把任务堆积到工作队列（可定义）中；</li>
<li>当工作队列满了后扩容线程池，一直到达到最大线程数（可定义）为止；</li>
<li>如果队列已满且达到了最大线程后还有任务进来，按照拒绝策略处理（可定义）；</li>
<li>当线程数大于核心线程数时，线程等待一段时间（可定义）后还是没有任务需要处理的话，收缩线程到核心线程数。</li>
</ul>
<p>了解工作行为有助于我们根据实际的容量规划需求，为线程池设置合适的初始化参数。ThreadPoolExecutor最完备的构造函数有 7 个参数，以下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    </span><br><span class="line">ThreadPoolExecutor(</span><br><span class="line">  <span class="keyword">int</span> corePoolSize,</span><br><span class="line">  <span class="keyword">int</span> maximumPoolSize,</span><br><span class="line">  <span class="keyword">long</span> keepAliveTime,</span><br><span class="line">  TimeUnit unit,</span><br><span class="line">  BlockingQueue&lt;Runnable&gt; workQueue,</span><br><span class="line">  ThreadFactory threadFactory,</span><br><span class="line">  RejectedExecutionHandler handler)</span><br></pre></td></tr></table></figure>
<p><code>corePoolSize</code>核心线程数，表示线程池保有的最小线程数。<br><code>maximumPoolSize</code>表示线程池创建的最大线程数。当核心线程数不够用时，且工作队列也满了，线程池就会再创建 maximumPoolSize 个线程。<br><code>keepAliveTime &amp; unit</code>一个线程如果在一段时间内，都没有执行任务，说明很闲，keepAliveTime 和 unit 就是用来定义这个“一段时间”的参数。也就是说，如果一个线程空闲了keepAliveTime &amp; unit这么久，而且线程池的线程数大于 corePoolSize ，那么这个空闲的线程就要被回收了。<br><code>unit</code>空闲时间的单位<br><code>workQueue</code>工作队列，当核心线程数来不及处理时，就会先把任务放在工作队列里。<br><code>threadFactory</code>通过这个参数可以自定义如何创建线程，例如可以给线程指定一个有意义的名字。<br><code>handler</code>通过这个参数可以自定义任务的拒绝策略。如果线程池中所有的线程都在忙碌，并且工作队列也满了（前提是工作队列是有界队列，如果队列无界且任务过多，可能会导致OOM），那么此时提交任务，线程池就会拒绝接收。至于拒绝的策略，可以通过 handler 这个参数来指定。</p>
<h2 id="四种拒绝策略"><a href="#四种拒绝策略" class="headerlink" title="四种拒绝策略"></a><strong>四种拒绝策略</strong></h2><p>使用有界队列，当任务过多时，线程池会触发执行拒绝策略，线程池默认的拒绝策略会 throw RejectedExecutionException 。因此默认拒绝策略要慎重使用。如果线程池处理的任务非常重要，建议自定义自己的拒绝策略；并且在实际工作中，自定义的拒绝策略往往和降级策略配合使用。ThreadPoolExecutor 已经提供了以下 4 种策略：</p>
<ol>
<li><strong>CallerRunsPolicy</strong>：提交任务的线程自己去执行该任务。</li>
<li><strong>AbortPolicy</strong>：默认的拒绝策略，会 throw RejectedExecutionException。</li>
<li><strong>DiscardPolicy</strong>：直接丢弃任务，没有任何异常抛出。</li>
<li><strong>DiscardOldestPolicy</strong>：丢弃最老的任务，其实就是把最早进入工作队列的任务丢弃，然后把新任务加入到工作队列。</li>
</ol>
<p>然后我们用一段测试代码来看下拒绝策略的不同处理。测试代码的逻辑为，每次间隔 1 秒向线程池提交任务，循环 20 次，每个任务需要 10 秒才能执行完成。</p>
<h3 id="使用默认的拒绝策略AbortPolicy-抛异常"><a href="#使用默认的拒绝策略AbortPolicy-抛异常" class="headerlink" title="使用默认的拒绝策略AbortPolicy-抛异常"></a>使用默认的拒绝策略AbortPolicy-抛异常</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//使用一个计数器跟踪完成的任务数</span></span><br><span class="line">    AtomicInteger atomicInteger = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line">    <span class="comment">//创建一个具有2个核心线程、5个最大线程，使用容量为10的ArrayBlockingQueue阻塞队列作为工作队列的线程池，使用默认的AbortPolicy拒绝策略</span></span><br><span class="line">    ThreadPoolExecutor threadPool = <span class="keyword">new</span> ThreadPoolExecutor( <span class="number">2</span>, <span class="number">5</span>, <span class="number">5</span>, TimeUnit.SECONDS, <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">10</span>),</span><br><span class="line">            <span class="keyword">new</span> ThreadFactoryBuilder().setNameFormat(<span class="string">"demo-threadpool-%d"</span>).build(), <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy());</span><br><span class="line">    IntStream.rangeClosed(<span class="number">1</span>, <span class="number">20</span>).forEach(i -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> id = atomicInteger.incrementAndGet();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            threadPool.execute(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    process(id);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            log.error(<span class="string">"任务&#123;&#125; 发生异常"</span>, id, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="keyword">int</span> id)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    log.info(<span class="string">"准备执行任务 &#123;&#125; "</span>, id);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">10</span>);<span class="comment">//每个任务耗时10秒</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">"任务&#123;&#125; 执行完成"</span>, id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看一下运行日志，抛了java.util.concurrent.RejectedExecutionException异常，任务18、19、20没有被处理。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">20:49:53.032 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 1</span><br><span class="line">20:49:54.029 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 2</span><br><span class="line">20:50:03.041 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务1 执行完成</span><br><span class="line">20:50:03.041 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 3</span><br><span class="line">20:50:04.029 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务2 执行完成</span><br><span class="line">20:50:04.029 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 4</span><br><span class="line">20:50:07.036 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 15</span><br><span class="line">20:50:08.037 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 16</span><br><span class="line">20:50:09.037 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 17</span><br><span class="line">20:50:10.041 [main] ERROR com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务18 发生异常</span><br><span class="line">java.util.concurrent.RejectedExecutionException: Task com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush$$Lambda$2/2081303229@50c87b21 rejected from java.util.concurrent.ThreadPoolExecutor@5f375618[Running, pool size = 5, active threads = 5, queued tasks = 10, completed tasks = 2]</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2063)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:830)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1379)</span><br><span class="line">at com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush.lambda$main$1(AssetItemScrapStatusPush.java:74)</span><br><span class="line">at java.util.stream.Streams$RangeIntSpliterator.forEachRemaining(Streams.java:110)</span><br><span class="line">at java.util.stream.IntPipeline$Head.forEach(IntPipeline.java:557)</span><br><span class="line">at com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush.main(AssetItemScrapStatusPush.java:66)</span><br><span class="line">20:50:11.041 [main] ERROR com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务19 发生异常</span><br><span class="line">java.util.concurrent.RejectedExecutionException: Task com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush$$Lambda$2/2081303229@5d5eef3d rejected from java.util.concurrent.ThreadPoolExecutor@5f375618[Running, pool size = 5, active threads = 5, queued tasks = 10, completed tasks = 2]</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2063)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:830)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1379)</span><br><span class="line">at com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush.lambda$main$1(AssetItemScrapStatusPush.java:74)</span><br><span class="line">at java.util.stream.Streams$RangeIntSpliterator.forEachRemaining(Streams.java:110)</span><br><span class="line">at java.util.stream.IntPipeline$Head.forEach(IntPipeline.java:557)</span><br><span class="line">at com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush.main(AssetItemScrapStatusPush.java:66)</span><br><span class="line">20:50:12.042 [main] ERROR com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务20 发生异常</span><br><span class="line">java.util.concurrent.RejectedExecutionException: Task com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush$$Lambda$2/2081303229@56f4468b rejected from java.util.concurrent.ThreadPoolExecutor@5f375618[Running, pool size = 5, active threads = 5, queued tasks = 10, completed tasks = 2]</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2063)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:830)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1379)</span><br><span class="line">at com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush.lambda$main$1(AssetItemScrapStatusPush.java:74)</span><br><span class="line">at java.util.stream.Streams$RangeIntSpliterator.forEachRemaining(Streams.java:114)</span><br><span class="line">at java.util.stream.IntPipeline$Head.forEach(IntPipeline.java:557)</span><br><span class="line">at com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush.main(AssetItemScrapStatusPush.java:66)</span><br><span class="line">20:50:13.041 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务3 执行完成</span><br><span class="line">20:50:13.041 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 5</span><br><span class="line">20:50:14.030 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务4 执行完成</span><br><span class="line">20:50:14.030 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 6</span><br><span class="line">20:50:17.037 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务15 执行完成</span><br><span class="line">20:50:17.037 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 7</span><br><span class="line">20:50:18.037 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务16 执行完成</span><br><span class="line">20:50:18.037 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 8</span><br><span class="line">20:50:19.038 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务17 执行完成</span><br><span class="line">20:50:19.038 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 9</span><br><span class="line">20:50:23.042 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务5 执行完成</span><br><span class="line">20:50:23.043 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 10</span><br><span class="line">20:50:24.037 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务6 执行完成</span><br><span class="line">20:50:24.037 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 11</span><br><span class="line">20:50:27.037 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务7 执行完成</span><br><span class="line">20:50:27.037 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 12</span><br><span class="line">20:50:28.038 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务8 执行完成</span><br><span class="line">20:50:28.038 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 13</span><br><span class="line">20:50:29.039 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务9 执行完成</span><br><span class="line">20:50:29.039 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 14</span><br><span class="line">20:50:33.044 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务10 执行完成</span><br><span class="line">20:50:34.038 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务11 执行完成</span><br><span class="line">20:50:37.037 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务12 执行完成</span><br><span class="line">20:50:38.038 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务13 执行完成</span><br><span class="line">20:50:39.039 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务14 执行完成</span><br></pre></td></tr></table></figure>
<p>如果我们的任务很重要，那我们可以在catch 住异常之后再次对其进行处理, 例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//使用一个计数器跟踪完成的任务数</span></span><br><span class="line">        AtomicInteger atomicInteger = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line">        <span class="comment">//创建一个具有2个核心线程、5个最大线程，使用容量为10的ArrayBlockingQueue阻塞队列作为工作队列的线程池，使用默认的AbortPolicy拒绝策略</span></span><br><span class="line">        ThreadPoolExecutor threadPool = <span class="keyword">new</span> ThreadPoolExecutor( <span class="number">2</span>, <span class="number">5</span>, <span class="number">5</span>, TimeUnit.SECONDS, <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">10</span>),</span><br><span class="line">                <span class="keyword">new</span> ThreadFactoryBuilder().setNameFormat(<span class="string">"demo-threadpool-%d"</span>).build(), <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy());</span><br><span class="line">        IntStream.rangeClosed(<span class="number">1</span>, <span class="number">20</span>).forEach(i -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> id = atomicInteger.incrementAndGet();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                threadPool.execute(() -&gt; &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        process(id);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                log.error(<span class="string">"任务&#123;&#125; 发生异常"</span>, id, ex);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    process(id);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>看一下运行日志，catch住异常后main线程自己去处理这个任务。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">21:04:24.146 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 1</span><br><span class="line">21:04:25.142 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 2</span><br><span class="line">21:04:34.156 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务1 执行完成</span><br><span class="line">21:04:34.156 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 3</span><br><span class="line">21:04:35.143 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务2 执行完成</span><br><span class="line">21:04:35.143 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 4</span><br><span class="line">21:04:38.149 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 15</span><br><span class="line">21:04:39.150 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 16</span><br><span class="line">21:04:40.150 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 17</span><br><span class="line">21:04:41.153 [main] ERROR com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务18 发生异常</span><br><span class="line">java.util.concurrent.RejectedExecutionException: Task com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush$$Lambda$2/2081303229@50c87b21 rejected from java.util.concurrent.ThreadPoolExecutor@5f375618[Running, pool size = 5, active threads = 5, queued tasks = 10, completed tasks = 2]</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2063)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:830)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1379)</span><br><span class="line">at com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush.lambda$main$1(AssetItemScrapStatusPush.java:74)</span><br><span class="line">at java.util.stream.Streams$RangeIntSpliterator.forEachRemaining(Streams.java:110)</span><br><span class="line">at java.util.stream.IntPipeline$Head.forEach(IntPipeline.java:557)</span><br><span class="line">at com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush.main(AssetItemScrapStatusPush.java:66)</span><br><span class="line">21:04:41.154 [main] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 18</span><br><span class="line">21:04:44.156 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务3 执行完成</span><br><span class="line">21:04:44.156 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 5</span><br><span class="line">21:04:45.144 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务4 执行完成</span><br><span class="line">21:04:45.144 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 6</span><br><span class="line">21:04:48.151 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务15 执行完成</span><br><span class="line">21:04:48.151 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 7</span><br><span class="line">21:04:49.150 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务16 执行完成</span><br><span class="line">21:04:49.150 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 8</span><br><span class="line">21:04:50.151 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务17 执行完成</span><br><span class="line">21:04:50.151 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 9</span><br><span class="line">21:04:51.156 [main] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务18 执行完成</span><br><span class="line">21:04:54.156 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务5 执行完成</span><br><span class="line">21:04:54.156 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 10</span><br><span class="line">21:04:55.147 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务6 执行完成</span><br><span class="line">21:04:55.147 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 11</span><br><span class="line">21:04:58.151 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务7 执行完成</span><br><span class="line">21:04:58.151 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 12</span><br><span class="line">21:04:59.150 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务8 执行完成</span><br><span class="line">21:04:59.150 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 13</span><br><span class="line">21:05:00.152 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务9 执行完成</span><br><span class="line">21:05:00.152 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 14</span><br><span class="line">21:05:04.157 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务10 执行完成</span><br><span class="line">21:05:04.157 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 19</span><br><span class="line">21:05:05.147 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务11 执行完成</span><br><span class="line">21:05:05.147 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 20</span><br><span class="line">21:05:08.152 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务12 执行完成</span><br><span class="line">21:05:09.151 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务13 执行完成</span><br><span class="line">21:05:10.152 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务14 执行完成</span><br><span class="line">21:05:14.157 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务19 执行完成</span><br><span class="line">21:05:15.148 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务20 执行完成</span><br></pre></td></tr></table></figure>
<h3 id="CallerRunsPolicy-提交任务的线程自己去执行该任务"><a href="#CallerRunsPolicy-提交任务的线程自己去执行该任务" class="headerlink" title="CallerRunsPolicy-提交任务的线程自己去执行该任务"></a>CallerRunsPolicy-提交任务的线程自己去执行该任务</h3><p>把拒绝策略换成这个，我们再看一下运行日志，main线程自己执行了任务且没有抛出异常，所以当线程满队列也满的情况下，任务会在提交任务的线程，或者说调用 execute 方法的线程执行，也就是说不能认为提交到线程池的任务就一定是异步处理的。如果使用了 CallerRunsPolicy 策略，那么有可能异步任务变为同步执行。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">21:11:05.858 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 1</span><br><span class="line">21:11:06.856 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 2</span><br><span class="line">21:11:15.864 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务1 执行完成</span><br><span class="line">21:11:15.864 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 3</span><br><span class="line">21:11:16.856 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务2 执行完成</span><br><span class="line">21:11:16.856 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 4</span><br><span class="line">21:11:19.863 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 15</span><br><span class="line">21:11:20.863 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 16</span><br><span class="line">21:11:21.864 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 17</span><br><span class="line">21:11:22.865 [main] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 18</span><br><span class="line">21:11:25.865 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务3 执行完成</span><br><span class="line">21:11:25.865 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 5</span><br><span class="line">21:11:26.856 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务4 执行完成</span><br><span class="line">21:11:26.856 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 6</span><br><span class="line">21:11:29.864 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务15 执行完成</span><br><span class="line">21:11:29.864 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 7</span><br><span class="line">21:11:30.864 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务16 执行完成</span><br><span class="line">21:11:30.864 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 8</span><br><span class="line">21:11:31.865 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务17 执行完成</span><br><span class="line">21:11:31.865 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 9</span><br><span class="line">21:11:32.865 [main] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务18 执行完成</span><br><span class="line">21:11:35.866 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务5 执行完成</span><br><span class="line">21:11:35.866 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 10</span><br><span class="line">21:11:36.856 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务6 执行完成</span><br><span class="line">21:11:36.858 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 11</span><br><span class="line">21:11:39.864 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务7 执行完成</span><br><span class="line">21:11:39.864 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 12</span><br><span class="line">21:11:40.865 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务8 执行完成</span><br><span class="line">21:11:40.865 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 13</span><br><span class="line">21:11:41.865 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务9 执行完成</span><br><span class="line">21:11:41.865 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 14</span><br><span class="line">21:11:45.866 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务10 执行完成</span><br><span class="line">21:11:45.866 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 19</span><br><span class="line">21:11:46.859 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务11 执行完成</span><br><span class="line">21:11:46.859 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 20</span><br><span class="line">21:11:49.865 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务12 执行完成</span><br><span class="line">21:11:50.865 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务13 执行完成</span><br><span class="line">21:11:51.865 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务14 执行完成</span><br><span class="line">21:11:55.867 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务19 执行完成</span><br><span class="line">21:11:56.860 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务20 执行完成</span><br></pre></td></tr></table></figure>
<h3 id="DiscardPolicy-直接丢弃任务"><a href="#DiscardPolicy-直接丢弃任务" class="headerlink" title="DiscardPolicy-直接丢弃任务"></a><strong>DiscardPolicy-直接丢弃任务</strong></h3><p>看日志会发现任务18、19、20都被丢掉了。。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">21:15:12.036 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 1</span><br><span class="line">21:15:13.032 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 2</span><br><span class="line">21:15:22.050 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务1 执行完成</span><br><span class="line">21:15:22.050 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 3</span><br><span class="line">21:15:23.032 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务2 执行完成</span><br><span class="line">21:15:23.032 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 4</span><br><span class="line">21:15:26.040 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 15</span><br><span class="line">21:15:27.041 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 16</span><br><span class="line">21:15:28.042 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 17</span><br><span class="line">21:15:32.050 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务3 执行完成</span><br><span class="line">21:15:32.050 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 5</span><br><span class="line">21:15:33.033 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务4 执行完成</span><br><span class="line">21:15:33.034 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 6</span><br><span class="line">21:15:36.042 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务15 执行完成</span><br><span class="line">21:15:36.042 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 7</span><br><span class="line">21:15:37.042 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务16 执行完成</span><br><span class="line">21:15:37.042 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 8</span><br><span class="line">21:15:38.044 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务17 执行完成</span><br><span class="line">21:15:38.044 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 9</span><br><span class="line">21:15:42.051 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务5 执行完成</span><br><span class="line">21:15:42.051 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 10</span><br><span class="line">21:15:43.034 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务6 执行完成</span><br><span class="line">21:15:43.034 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 11</span><br><span class="line">21:15:46.042 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务7 执行完成</span><br><span class="line">21:15:46.044 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 12</span><br><span class="line">21:15:47.043 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务8 执行完成</span><br><span class="line">21:15:47.043 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 13</span><br><span class="line">21:15:48.044 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务9 执行完成</span><br><span class="line">21:15:48.044 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 14</span><br><span class="line">21:15:52.052 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务10 执行完成</span><br><span class="line">21:15:53.034 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务11 执行完成</span><br><span class="line">21:15:56.044 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务12 执行完成</span><br><span class="line">21:15:57.044 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务13 执行完成</span><br><span class="line">21:15:58.044 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务14 执行完成</span><br></pre></td></tr></table></figure>
<h3 id="DiscardOldestPolicy-丢弃最老的任务，加入新的任务"><a href="#DiscardOldestPolicy-丢弃最老的任务，加入新的任务" class="headerlink" title="DiscardOldestPolicy-丢弃最老的任务，加入新的任务"></a><strong>DiscardOldestPolicy-丢弃最老的任务，加入新的任务</strong></h3><p>从日志中发现，任务5、6、7被丢弃了，猜测应该是抛弃了5、6、7，加入了18、19、20</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">21:26:28.413 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 1</span><br><span class="line">21:26:29.411 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 2</span><br><span class="line">21:26:38.420 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务1 执行完成</span><br><span class="line">21:26:38.420 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 3</span><br><span class="line">21:26:39.411 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务2 执行完成</span><br><span class="line">21:26:39.411 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 4</span><br><span class="line">21:26:42.417 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 15</span><br><span class="line">21:26:43.420 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 16</span><br><span class="line">21:26:44.418 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 17</span><br><span class="line">21:26:48.420 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务3 执行完成</span><br><span class="line">21:26:48.420 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 8</span><br><span class="line">21:26:49.412 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务4 执行完成</span><br><span class="line">21:26:49.412 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 9</span><br><span class="line">21:26:52.417 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务15 执行完成</span><br><span class="line">21:26:52.417 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 10</span><br><span class="line">21:26:53.423 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务16 执行完成</span><br><span class="line">21:26:53.423 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 11</span><br><span class="line">21:26:54.420 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务17 执行完成</span><br><span class="line">21:26:54.420 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 12</span><br><span class="line">21:26:58.421 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务8 执行完成</span><br><span class="line">21:26:58.421 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 13</span><br><span class="line">21:26:59.412 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务9 执行完成</span><br><span class="line">21:26:59.412 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 14</span><br><span class="line">21:27:02.418 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务10 执行完成</span><br><span class="line">21:27:02.420 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 18</span><br><span class="line">21:27:03.424 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务11 执行完成</span><br><span class="line">21:27:03.424 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 19</span><br><span class="line">21:27:04.420 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务12 执行完成</span><br><span class="line">21:27:04.420 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 准备执行任务 20</span><br><span class="line">21:27:08.421 [demo-threadpool-0] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务13 执行完成</span><br><span class="line">21:27:09.413 [demo-threadpool-1] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务14 执行完成</span><br><span class="line">21:27:12.421 [demo-threadpool-2] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务18 执行完成</span><br><span class="line">21:27:13.425 [demo-threadpool-3] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务19 执行完成</span><br><span class="line">21:27:14.421 [demo-threadpool-4] INFO com.enmonster.optimon.ars.mq.producer.AssetItemScrapStatusPush - 任务20 执行完成</span><br></pre></td></tr></table></figure>
<h2 id="总结-选择合适的拒绝策略"><a href="#总结-选择合适的拒绝策略" class="headerlink" title="总结-选择合适的拒绝策略"></a><strong>总结-选择合适的拒绝策略</strong></h2><p>上面有说到使用有界队列且任务过多时，线程池会触发执行拒绝策略，线程池默认的拒绝策略会 throw RejectedExecutionException ，如果任务在执行的过程中出现运行时异常，会导致执行任务的线程终止，最致命的是任务虽然异常了，但是你却获取不到任何通知，这会让你误以为任务都执行得很正常。所以在用线程池时一定要记得捕获异常并按需处理。</p>
<ul>
<li>如果是一些不重要任务，我们可以用<strong>DiscardPolicy</strong>直接丢弃或用<strong>DiscardOldestPolicy</strong>策略-能处理就处理，不能处理就丢弃。</li>
<li>如果使用了默认的拒绝策略，且任务挺重要，可以在捕获了异常后，采用一些补救措施，例如将任务信息插入数据库或者消息队列，启用一个专门用作补偿的线程池去进行补偿。</li>
<li>如果不希望线程池丢弃任务且又不想做其他处理，可以使用<strong>CallerRunsPolicy</strong>，让提交任务的线程自己去处理。</li>
</ul>
<p>在使用线程池时，我们经常会复用别人已经定义好的线程池，但其实最好是自己能够根据业务场景来定义，别人定义的线程池属性不一定适合我们的任务，而且混用会相互干扰。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2023/03/23/ThreadPoolExecutor%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%8B%92%E7%BB%9D%E7%AD%96%E7%95%A5/" data-id="clfkizvdq0006o4vb2cty2bgz" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Java8 Stream流操作总结" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2023/03/23/Java8%20Stream%E6%B5%81%E6%93%8D%E4%BD%9C%E6%80%BB%E7%BB%93/" class="article-date">
  <time datetime="2023-03-23T02:37:37.000Z" itemprop="datePublished">2023-03-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/03/23/Java8%20Stream%E6%B5%81%E6%93%8D%E4%BD%9C%E6%80%BB%E7%BB%93/">Java8 Stream流操作总结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h2><p>Stream流一般用于对集合进行投影、转换、过滤、排序等。<br>如下是常用的一些操作：</p>
<table>
<thead>
<tr>
<th><strong>方法</strong></th>
<th><strong>中文</strong></th>
<th><strong>操作类型</strong></th>
<th><strong>类比SQL</strong></th>
<th><strong>使用的类型/函数式接口</strong></th>
<th><strong>作用</strong></th>
</tr>
</thead>
<tbody><tr>
<td>filter</td>
<td>过滤/筛选</td>
<td>中间</td>
<td>where</td>
<td>Predicate<T></td>
<td>对流过滤，使元素符合传入条件</td>
</tr>
<tr>
<td>map</td>
<td>转换/投影</td>
<td>中间</td>
<td>select</td>
<td>Function&lt;T, R&gt;</td>
<td>使用传入的函数，对流中每一个元素进行转换</td>
</tr>
<tr>
<td>flatMap</td>
<td>展开/扁平化</td>
<td>中间</td>
<td>N/A</td>
<td>Function&lt;T, Stream<R>&gt;</td>
<td>相当于map+flat，通过map把每一个元素转换为一个流，</td>
</tr>
<tr>
<td>然后把所有流链接到一起扁平化展示</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>sorted</td>
<td>排序</td>
<td>中间</td>
<td>order by</td>
<td>Comparator<T></td>
<td>使用传入的比较器，对流中的元素排序</td>
</tr>
<tr>
<td>distinct</td>
<td>去重</td>
<td>中间</td>
<td>distinct</td>
<td>long</td>
<td>对流中元素去重（使用Object.equals判重）</td>
</tr>
<tr>
<td>skip &amp; limit</td>
<td>分页</td>
<td>中间</td>
<td>limit</td>
<td>long</td>
<td>跳过流中部分元素以及限制元素数量</td>
</tr>
<tr>
<td>collect</td>
<td>收集</td>
<td>终结</td>
<td>N/A</td>
<td>Collector&lt;T,A,R&gt;</td>
<td>对流进行终结操作，把流导出成为我们需要的数据结构</td>
</tr>
<tr>
<td>forEach</td>
<td>遍历</td>
<td>终结</td>
<td>N/A</td>
<td>Consumer<T></td>
<td>对每一个元素遍历进行消费</td>
</tr>
<tr>
<td>anyMatch</td>
<td>是否有元素匹配</td>
<td>终结</td>
<td>N/A</td>
<td>Predicate<T></td>
<td>使用谓词判断是否有任何一个元素满足匹配</td>
</tr>
<tr>
<td>allMatch</td>
<td>是否所有元素匹配</td>
<td>终结</td>
<td>N/A</td>
<td>Predicate<T></td>
<td>使用谓词判断是否所有元素都满足匹配</td>
</tr>
</tbody></table>
<h2 id="二、操作详解"><a href="#二、操作详解" class="headerlink" title="二、操作详解"></a>二、操作详解</h2><h3 id="创建流"><a href="#创建流" class="headerlink" title="创建流"></a>创建流</h3><p>要使用流，就要先创建流。创建流一般有五种方式：<br>1、通过 stream 方法把 List 或数组转换为流；<br>2、通过 Stream.of 方法直接传入多个元素构成一个流；<br>3、通过 Stream.iterate 方法使用迭代的方式构造一个无限流，然后使用 limit 限制流元素个数；<br>4、通过 Stream.generate 方法从外部传入一个提供元素的 Supplier 来构造无限流，然后使用 limit 限制流元素个数；<br>5、通过 IntStream 或 DoubleStream 构造基本类型的流。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过stream方法把List或数组转换为流</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stream</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Arrays.asList(<span class="string">"a1"</span>, <span class="string">"a2"</span>, <span class="string">"a3"</span>).stream().forEach(System.out::println);</span><br><span class="line">    Arrays.stream(<span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;).forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//通过Stream.of方法直接传入多个元素构成一个流</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">of</span><span class="params">()</span></span>&#123;</span><br><span class="line">    String[] arr = &#123;<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>&#125;;</span><br><span class="line">    Stream.of(arr).forEach(System.out::println);</span><br><span class="line">    Stream.of(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>).forEach(System.out::println);</span><br><span class="line">    Stream.of(<span class="number">1</span>, <span class="number">2</span>, <span class="string">"a"</span>).map(item -&gt; item.getClass().getName()).forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//通过Stream.iterate方法使用迭代的方式构造一个无限流，然后使用limit限制流元素个数</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">iterate</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Stream.iterate(<span class="number">2</span>, item -&gt; item * <span class="number">2</span>).limit(<span class="number">10</span>).forEach(System.out::println);</span><br><span class="line">    Stream.iterate(BigInteger.ZERO, n -&gt; n.add(BigInteger.TEN)).limit(<span class="number">10</span>).forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//通过Stream.generate方法从外部传入一个提供元素的Supplier来构造无限流，然后使用limit限制流元素个数</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">generate</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Stream.generate(() -&gt; <span class="string">"test"</span>).limit(<span class="number">3</span>).forEach(System.out::println);</span><br><span class="line">    Stream.generate(Math::random).limit(<span class="number">10</span>).forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//通过IntStream或DoubleStream构造基本类型的流</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">primitive</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//演示IntStream和DoubleStream</span></span><br><span class="line">    IntStream.range(<span class="number">1</span>, <span class="number">3</span>).forEach(System.out::println);</span><br><span class="line">    IntStream.range(<span class="number">0</span>, <span class="number">3</span>).mapToObj(i -&gt; <span class="string">"x"</span>).forEach(System.out::println);</span><br><span class="line"> </span><br><span class="line">    IntStream.rangeClosed(<span class="number">1</span>, <span class="number">3</span>).forEach(System.out::println);</span><br><span class="line">    DoubleStream.of(<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>).forEach(System.out::println);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//各种转换，后面注释代表了输出结果</span></span><br><span class="line">    System.out.println(IntStream.of(<span class="number">1</span>, <span class="number">2</span>).toArray().getClass()); <span class="comment">//class [I</span></span><br><span class="line">    System.out.println(Stream.of(<span class="number">1</span>, <span class="number">2</span>).mapToInt(Integer::intValue).toArray().getClass()); <span class="comment">//class [I</span></span><br><span class="line">    System.out.println(IntStream.of(<span class="number">1</span>, <span class="number">2</span>).boxed().toArray().getClass()); <span class="comment">//class [Ljava.lang.Object;</span></span><br><span class="line">    System.out.println(IntStream.of(<span class="number">1</span>, <span class="number">2</span>).asDoubleStream().toArray().getClass()); <span class="comment">//class [D</span></span><br><span class="line">    System.out.println(IntStream.of(<span class="number">1</span>, <span class="number">2</span>).asLongStream().toArray().getClass()); <span class="comment">//class [J</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">//注意基本类型流和装箱后的流的区别</span></span><br><span class="line">    Arrays.asList(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>).stream()   <span class="comment">// Stream&lt;String&gt;</span></span><br><span class="line">            .mapToInt(String::length)       <span class="comment">// IntStream</span></span><br><span class="line">            .asLongStream()                 <span class="comment">// LongStream</span></span><br><span class="line">            .mapToDouble(x -&gt; x / <span class="number">10.0</span>)     <span class="comment">// DoubleStream</span></span><br><span class="line">            .boxed()                        <span class="comment">// Stream&lt;Double&gt;</span></span><br><span class="line">            .mapToLong(x -&gt; <span class="number">1L</span>)             <span class="comment">// LongStream</span></span><br><span class="line">            .mapToObj(x -&gt; <span class="string">""</span>)              <span class="comment">// Stream&lt;String&gt;</span></span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，通过模拟订单相关的场景来使用stream流进行操作，方便理解。<br>定义订单类、商品类、顾客类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 商品类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiuZiyu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/03/18 18:19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderItem</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long productId;</span><br><span class="line">    <span class="keyword">private</span> String productName;</span><br><span class="line">    <span class="keyword">private</span> Double productPrice;</span><br><span class="line">    <span class="keyword">private</span> Integer productQuantity;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 产品</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiuZiyu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/03/18 18:21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Double price;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Product&gt; <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(</span><br><span class="line">                <span class="keyword">new</span> Product(<span class="number">1L</span>, <span class="string">"苹果"</span>, <span class="number">1.0</span>),</span><br><span class="line">                <span class="keyword">new</span> Product(<span class="number">2L</span>, <span class="string">"桔子"</span>, <span class="number">2.0</span>),</span><br><span class="line">                <span class="keyword">new</span> Product(<span class="number">3L</span>, <span class="string">"香蕉"</span>, <span class="number">3.0</span>),</span><br><span class="line">                <span class="keyword">new</span> Product(<span class="number">4L</span>, <span class="string">"芒果"</span>, <span class="number">4.0</span>),</span><br><span class="line">                <span class="keyword">new</span> Product(<span class="number">5L</span>, <span class="string">"西瓜"</span>, <span class="number">5.0</span>),</span><br><span class="line">                <span class="keyword">new</span> Product(<span class="number">6L</span>, <span class="string">"葡萄"</span>, <span class="number">6.0</span>),</span><br><span class="line">                <span class="keyword">new</span> Product(<span class="number">7L</span>, <span class="string">"桃子"</span>, <span class="number">7.0</span>),</span><br><span class="line">                <span class="keyword">new</span> Product(<span class="number">8L</span>, <span class="string">"椰子"</span>, <span class="number">8.0</span>),</span><br><span class="line">                <span class="keyword">new</span> Product(<span class="number">9L</span>, <span class="string">"菠萝"</span>, <span class="number">9.0</span>),</span><br><span class="line">                <span class="keyword">new</span> Product(<span class="number">10L</span>, <span class="string">"石榴"</span>, <span class="number">10.0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 顾客</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiuZiyu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/03/18 18:22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Customer&gt; <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(</span><br><span class="line">                <span class="keyword">new</span> Customer(<span class="number">10L</span>, <span class="string">"小张"</span>),</span><br><span class="line">                <span class="keyword">new</span> Customer(<span class="number">11L</span>, <span class="string">"小王"</span>),</span><br><span class="line">                <span class="keyword">new</span> Customer(<span class="number">12L</span>, <span class="string">"小李"</span>),</span><br><span class="line">                <span class="keyword">new</span> Customer(<span class="number">13L</span>, <span class="string">"小朱"</span>),</span><br><span class="line">                <span class="keyword">new</span> Customer(<span class="number">14L</span>, <span class="string">"小徐"</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 订单类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiuZiyu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/03/18 18:18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> Long customerId;</span><br><span class="line">    <span class="keyword">private</span> String customerName;</span><br><span class="line">    <span class="keyword">private</span> List&lt;OrderItem&gt; orderItemList;</span><br><span class="line">    <span class="keyword">private</span> Double totalPrice;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime placedAt;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Order&gt; <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Product&gt; products = Product.getData();</span><br><span class="line">        List&lt;Customer&gt; customers = Customer.getData();</span><br><span class="line"> </span><br><span class="line">        Random random = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">return</span> LongStream.rangeClosed(<span class="number">1</span>, <span class="number">10</span>).mapToObj(i -&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            Order order = <span class="keyword">new</span> Order();</span><br><span class="line">            order.setId(i);</span><br><span class="line">            order.setPlacedAt(LocalDateTime.now().minusHours(random.nextInt(<span class="number">24</span> * <span class="number">365</span>)));</span><br><span class="line"> </span><br><span class="line">            order.setOrderItemList(IntStream.rangeClosed(<span class="number">1</span>, random.ints(<span class="number">1</span>, <span class="number">1</span>, <span class="number">8</span>).findFirst().getAsInt()).mapToObj(j -&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                OrderItem orderItem = <span class="keyword">new</span> OrderItem();</span><br><span class="line">                Product product = products.get(random.nextInt(products.size()));</span><br><span class="line">                orderItem.setProductId(product.getId());</span><br><span class="line">                orderItem.setProductName(product.getName());</span><br><span class="line">                orderItem.setProductPrice(product.getPrice());</span><br><span class="line">                orderItem.setProductQuantity(random.ints(<span class="number">1</span>, <span class="number">1</span>, <span class="number">5</span>).findFirst().getAsInt());</span><br><span class="line">                <span class="keyword">return</span> orderItem;</span><br><span class="line">            &#125;).collect(Collectors.toList()));</span><br><span class="line">            order.setTotalPrice(order.getOrderItemList().stream().mapToDouble(item -&gt; item.getProductPrice() * item.getProductQuantity()).sum());</span><br><span class="line"> </span><br><span class="line">            Customer customer = customers.get(random.nextInt(customers.size()));</span><br><span class="line">            order.setCustomerId(customer.getId());</span><br><span class="line">            order.setCustomerName(customer.getName());</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">return</span> order;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h3><p>filter 方法可以实现过滤操作，类似 SQL 中的 where。我们可以使用一行代码，通过 filter 方法实现查询所有订单中最近半年金额大于 40 的订单，通过连续叠加 filter 方法进行多次条件过滤：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//最近半年的金额大于40的订单</span></span><br><span class="line">orders.stream()</span><br><span class="line">        .filter(Objects::nonNull) <span class="comment">//过滤null值</span></span><br><span class="line">        .filter(order -&gt; order.getPlacedAt().isAfter(LocalDateTime.now().minusMonths(<span class="number">6</span>))) <span class="comment">//最近半年的订单</span></span><br><span class="line">        .filter(order -&gt; order.getTotalPrice() &gt; <span class="number">40</span>) <span class="comment">//金额大于40的订单</span></span><br><span class="line">        .forEach(System.out::println); </span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line">orders.stream()</span><br><span class="line">        .filter(order -&gt; Objects.nonNull(order) &amp;&amp; order.getPlacedAt().isAfter(LocalDateTime.now().minusMonths(<span class="number">6</span>)) &amp;&amp; order.getTotalPrice() &gt; <span class="number">40</span>)</span><br><span class="line">        .forEach(System.out::println);</span><br></pre></td></tr></table></figure>
<h3 id="map"><a href="#map" class="headerlink" title="map"></a>map</h3><p>map 操作可以做转换（或者说投影），类似 SQL 中的 select。这里用两种方式统计订单中所有商品的数量，前一种是通过两次遍历实现，后一种是通过两次 mapToLong+sum 方法实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//计算所有订单商品数量</span></span><br><span class="line"><span class="comment">//通过两次遍历实现</span></span><br><span class="line">LongAdder longAdder = <span class="keyword">new</span> LongAdder();</span><br><span class="line">orders.stream().forEach(order -&gt;</span><br><span class="line">        order.getOrderItemList().forEach(orderItem -&gt; longAdder.add(orderItem.getProductQuantity())));</span><br><span class="line"> </span><br><span class="line"><span class="comment">//使用两次mapToLong+sum方法实现</span></span><br><span class="line">orders.stream()</span><br><span class="line">        .mapToLong(order -&gt; order.getOrderItemList().stream().mapToLong(OrderItem::getProductQuantity).sum())</span><br><span class="line">        .sum();</span><br></pre></td></tr></table></figure>
<h3 id="flatMap"><a href="#flatMap" class="headerlink" title="flatMap"></a>flatMap</h3><p>flatMap 展开或者叫扁平化操作，相当于 map+flat，通过 map 把每一个元素替换为一个流，然后展开这个流。比如，我们要统计所有订单的总价格，如果不依赖订单中的总价格字段，可以有两种方式：<br>第一种，直接通过原始商品列表的商品个数 * 商品单价进行统计，可以先把订单通过 flatMap 展开成商品清单，也就是把 Order 替换为 Stream，然后对每一个 OrderItem 用 mapToDouble 转换获得商品总价，最后进行一次 sum 求和；<br>第二种，利用 flatMapToDouble 方法把列表中每一项展开替换为一个 DoubleStream，也就是直接把每一个订单转换为每一个商品的总价，然后求和。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//依赖订单上的总价格字段</span></span><br><span class="line">orders.stream().mapToDouble(Order::getTotalPrice).sum();</span><br><span class="line"> </span><br><span class="line"><span class="comment">//直接展开订单商品进行价格统计</span></span><br><span class="line">orders.stream()</span><br><span class="line">        .flatMap(order -&gt; order.getOrderItemList().stream())</span><br><span class="line">        .mapToDouble(item -&gt; item.getProductQuantity() * item.getProductPrice()).sum();</span><br><span class="line"> </span><br><span class="line"><span class="comment">//另一种方式flatMap+mapToDouble=flatMapToDouble</span></span><br><span class="line">orders.stream()</span><br><span class="line">        .flatMapToDouble(order -&gt;</span><br><span class="line">                order.getOrderItemList()</span><br><span class="line">                        .stream().mapToDouble(item -&gt; item.getProductQuantity() * item.getProductPrice()))</span><br><span class="line">        .sum();</span><br></pre></td></tr></table></figure>
<h3 id="sorted"><a href="#sorted" class="headerlink" title="sorted"></a>sorted</h3><p>sorted 操作可以用于行内排序的场景，类似 SQL 中的 order by。比如，要实现大于 50 元订单的按价格倒序取前 5，可以通过 Order::getTotalPrice 方法引用直接指定需要排序的依据字段，通过 reversed() 实现倒序：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//大于50的订单,按照订单价格倒序前5</span></span><br><span class="line">orders.stream()</span><br><span class="line">        .filter(order -&gt; order.getTotalPrice() &gt; <span class="number">50</span>)</span><br><span class="line">        .sorted(comparing(Order::getTotalPrice).reversed())</span><br><span class="line">        .limit(<span class="number">5</span>)</span><br><span class="line">        .forEach(System.out::println);</span><br></pre></td></tr></table></figure>
<h3 id="distinct"><a href="#distinct" class="headerlink" title="distinct"></a>distinct</h3><p>distinct 操作的作用是去重，类似 SQL 中的 distinct。比如下面的代码实现：</p>
<ul>
<li><p>查询去重后的下单用户。使用 map 从订单提取出购买用户，然后使用 distinct 去重。</p>
</li>
<li><p>查询购买过的商品名。使用 flatMap+map 提取出订单中所有的商品名，然后使用 distinct 去重。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//去重的下单用户</span></span><br><span class="line">System.out.println(orders.stream().map(order -&gt; order.getCustomerName()).distinct().collect(joining(<span class="string">","</span>)));</span><br><span class="line"> </span><br><span class="line"><span class="comment">//所有购买过的商品</span></span><br><span class="line">System.out.println(orders.stream()</span><br><span class="line">        .flatMap(order -&gt; order.getOrderItemList().stream())</span><br><span class="line">        .map(OrderItem::getProductName)</span><br><span class="line">        .distinct().collect(joining(<span class="string">","</span>)));</span><br></pre></td></tr></table></figure>
<h3 id="skip-amp-limit"><a href="#skip-amp-limit" class="headerlink" title="skip &amp; limit"></a>skip &amp; limit</h3><p>skip 和 limit 操作用于分页，类似 MySQL 中的 limit。其中，skip 实现跳过一定的项，limit 用于限制项总数。比如下面的两段代码：</p>
</li>
<li><p>按照下单时间排序，查询前 2 个订单的顾客姓名和下单时间；</p>
</li>
<li><p>按照下单时间排序，查询第 3 和第 4 个订单的顾客姓名和下单时间。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//按照下单时间排序，查询前2个订单的顾客姓名和下单时间</span></span><br><span class="line">orders.stream()</span><br><span class="line">        .sorted(comparing(Order::getPlacedAt))</span><br><span class="line">        .map(order -&gt; order.getCustomerName() + <span class="string">"@"</span> + order.getPlacedAt())</span><br><span class="line">        .limit(<span class="number">2</span>).forEach(System.out::println);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//按照下单时间排序，查询第3和第4个订单的顾客姓名和下单时间</span></span><br><span class="line">orders.stream()</span><br><span class="line">        .sorted(comparing(Order::getPlacedAt))</span><br><span class="line">        .map(order -&gt; order.getCustomerName() + <span class="string">"@"</span> + order.getPlacedAt())</span><br><span class="line">        .skip(<span class="number">2</span>).limit(<span class="number">2</span>).forEach(System.out::println);</span><br></pre></td></tr></table></figure>
<h3 id="collect"><a href="#collect" class="headerlink" title="collect"></a>collect</h3><p>collect 是收集操作，对流进行终结（终止）操作，把流导出为我们需要的数据结构。“终结”是指，导出后，无法再串联使用其他中间操作，比如 filter、map、flatmap、sorted、distinct、limit、skip。<br>接下来，通过 6 个例子，来演示下几种比较常用的 collect 操作：<br>1、实现了字符串拼接操作，生成一定位数的随机字符串。<br>2、通过 Collectors.toSet 静态方法收集为 Set 去重，得到去重后的下单用户，再通过 Collectors.joining 静态方法实现字符串拼接。<br>3、通过 Collectors.toCollection 静态方法获得指定类型的集合，比如把 List转换为 LinkedList。<br>4、通过 Collectors.toMap 静态方法将对象快速转换为 Map，Key 是订单 ID、Value 是下单用户名。<br>5、通过 Collectors.toMap 静态方法将对象转换为 Map。Key 是下单用户名，Value 是下单时间，一个用户可能多次下单，所以直接在这里进行了合并，只获取最近一次的下单时间。<br>6、使用 Collectors.summingInt 方法对商品数量求和，再使用 Collectors.averagingInt 方法对结果求平均值，以统计所有订单平均购买的商品数量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生成一定位数的随机字符串</span></span><br><span class="line">System.out.println(random.ints(<span class="number">48</span>, <span class="number">122</span>)</span><br><span class="line">    .filter(i -&gt; (i &lt; <span class="number">57</span> || i &gt; <span class="number">65</span>) &amp;&amp; (i &lt; <span class="number">90</span> || i &gt; <span class="number">97</span>))</span><br><span class="line">    .mapToObj(i -&gt; (<span class="keyword">char</span>) i)</span><br><span class="line">    .limit(<span class="number">20</span>)</span><br><span class="line">    .collect(StringBuilder::<span class="keyword">new</span>, StringBuilder::append, StringBuilder::append)</span><br><span class="line">    .toString());</span><br><span class="line"> </span><br><span class="line"><span class="comment">//所有下单的用户，使用toSet去重后实现字符串拼接</span></span><br><span class="line">System.out.println(orders.stream()</span><br><span class="line">    .map(order -&gt; order.getCustomerName()).collect(toSet())</span><br><span class="line">    .stream().collect(joining(<span class="string">","</span>, <span class="string">"["</span>, <span class="string">"]"</span>)));</span><br><span class="line"> </span><br><span class="line"><span class="comment">//用toCollection收集器指定集合类型</span></span><br><span class="line">System.out.println(orders.stream().limit(<span class="number">2</span>).collect(toCollection(LinkedList::<span class="keyword">new</span>)).getClass());</span><br><span class="line"> </span><br><span class="line"><span class="comment">//使用toMap获取订单ID+下单用户名的Map</span></span><br><span class="line">orders.stream()</span><br><span class="line">    .collect(toMap(Order::getId, Order::getCustomerName))</span><br><span class="line">    .entrySet().forEach(System.out::println);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//使用toMap获取下单用户名+最近一次下单时间的Map</span></span><br><span class="line">orders.stream()</span><br><span class="line">    .collect(toMap(Order::getCustomerName, Order::getPlacedAt, (x, y) -&gt; x.isAfter(y) ? x : y))</span><br><span class="line">    .entrySet().forEach(System.out::println);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//订单平均购买的商品数量</span></span><br><span class="line">System.out.println(orders.stream().collect(averagingInt(order -&gt;</span><br><span class="line">    order.getOrderItemList().stream()</span><br><span class="line">            .collect(summingInt(OrderItem::getProductQuantity)))));</span><br></pre></td></tr></table></figure>
<p>下面为有关Collectors的静态方法：</p>
</li>
</ul>
<table>
<thead>
<tr>
<th><strong>方法</strong></th>
<th><strong>返回类型</strong></th>
<th><strong>作用</strong></th>
</tr>
</thead>
<tbody><tr>
<td>toList</td>
<td>List<T></td>
<td>把流中的元素收集成为一个List</td>
</tr>
<tr>
<td>toSet</td>
<td>Set<T></td>
<td>把流中的元素收集成为一个Set,去重</td>
</tr>
<tr>
<td>toCollection</td>
<td>Collection<T></td>
<td>把流中的元素收集成为指定的集合</td>
</tr>
<tr>
<td>counting</td>
<td>Long</td>
<td>计算流中的元素个数</td>
</tr>
<tr>
<td>summingInt</td>
<td>Integer</td>
<td>对流中的某个整数属性求和</td>
</tr>
<tr>
<td>averagingInt</td>
<td>Double</td>
<td>对流中元素的某个整数属性求平均值</td>
</tr>
<tr>
<td>joining</td>
<td>String</td>
<td>连接流中元素toString后的字符串</td>
</tr>
<tr>
<td>minBy</td>
<td>Optional<T></td>
<td>使用指定的比较器选出最小元素</td>
</tr>
<tr>
<td>maxBy</td>
<td>Optional<T></td>
<td>使用指定的比较器选出最大元素</td>
</tr>
<tr>
<td>collectingAndThen</td>
<td>根据收集器的返回</td>
<td>包裹另一个收集器，对结果进行转换</td>
</tr>
<tr>
<td>groupingBy</td>
<td>Map&lt;K, List<T>&gt;</td>
<td>根据元素的某个属性值对元素进行分组，属性值作为key</td>
</tr>
<tr>
<td>partitioningBy</td>
<td>Map&lt;Boolean, List<T>&gt;</td>
<td>根据流中元素应用谓词的结果，将元素分为true和false两个区</td>
</tr>
</tbody></table>
<h3 id="groupBy"><a href="#groupBy" class="headerlink" title="groupBy"></a>groupBy</h3><p>groupBy 是分组统计操作，类似 SQL 中的 group by 子句。它和后面介绍的 partitioningBy 都是特殊的收集器，同样也是终结操作。<br>以下的8个例子帮助理解：<br>1、按照用户名分组，使用 Collectors.counting 方法统计每个人的下单数量，再按照下单数量倒序输出。<br>2、按照用户名分组，使用 Collectors.summingDouble 方法统计订单总金额，再按总金额倒序输出。<br>3、按照用户名分组，使用两次 Collectors.summingInt 方法统计商品采购数量，再按总数量倒序输出。<br>4、统计被采购最多的商品。先通过 flatMap 把订单转换为商品，然后把商品名作为 Key、Collectors.summingInt 作为 Value 分组统计采购数量，再按 Value 倒序获取第一个 Entry，最后查询 Key 就得到了售出最多的商品。<br>5、同样统计采购最多的商品。相比第四个案例排序 Map 的方式，这次直接使用 Collectors.maxBy 收集器获得最大的 Entry。<br>6、按照用户名分组，统计用户下的金额最高的订单。Key 是用户名，Value 是 Order，直接通过 Collectors.maxBy 方法拿到金额最高的订单，然后通过 collectingAndThen 实现 Optional.get 的内容提取，最后遍历 Key/Value 即可。<br>7、根据下单年月分组统计订单 ID 列表。Key 是格式化成年月后的下单时间，Value 直接通过 Collectors.mapping 方法进行了转换，把订单列表转换为订单 ID 构成的 List。<br>8、根据下单年月 + 用户名两次分组统计订单 ID 列表，相比上一个案例多了一次分组操作，第二次分组是按照用户名进行分组。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//按照用户名分组，统计下单数量</span></span><br><span class="line">System.out.println(orders.stream().collect(groupingBy(Order::getCustomerName, counting()))</span><br><span class="line">        .entrySet().stream().sorted(Map.Entry.&lt;String, Long&gt;comparingByValue().reversed()).collect(toList()));</span><br><span class="line"> </span><br><span class="line"><span class="comment">//按照用户名分组，统计订单总金额</span></span><br><span class="line">System.out.println(orders.stream().collect(groupingBy(Order::getCustomerName, summingDouble(Order::getTotalPrice)))</span><br><span class="line">        .entrySet().stream().sorted(Map.Entry.&lt;String, Double&gt;comparingByValue().reversed()).collect(toList()));</span><br><span class="line"> </span><br><span class="line"><span class="comment">//按照用户名分组，统计商品采购数量</span></span><br><span class="line">System.out.println(orders.stream().collect(groupingBy(Order::getCustomerName,</span><br><span class="line">        summingInt(order -&gt; order.getOrderItemList().stream()</span><br><span class="line">                .collect(summingInt(OrderItem::getProductQuantity)))))</span><br><span class="line">        .entrySet().stream().sorted(Map.Entry.&lt;String, Integer&gt;comparingByValue().reversed()).collect(toList()));</span><br><span class="line"> </span><br><span class="line"><span class="comment">//统计最受欢迎的商品，倒序后取第一个</span></span><br><span class="line">orders.stream()</span><br><span class="line">        .flatMap(order -&gt; order.getOrderItemList().stream())</span><br><span class="line">        .collect(groupingBy(OrderItem::getProductName, summingInt(OrderItem::getProductQuantity)))</span><br><span class="line">        .entrySet().stream()</span><br><span class="line">        .sorted(Map.Entry.&lt;String, Integer&gt;comparingByValue().reversed())</span><br><span class="line">        .map(Map.Entry::getKey)</span><br><span class="line">        .findFirst()</span><br><span class="line">        .ifPresent(System.out::println);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//统计最受欢迎的商品的另一种方式，直接利用maxBy</span></span><br><span class="line">orders.stream()</span><br><span class="line">        .flatMap(order -&gt; order.getOrderItemList().stream())</span><br><span class="line">        .collect(groupingBy(OrderItem::getProductName, summingInt(OrderItem::getProductQuantity)))</span><br><span class="line">        .entrySet().stream()</span><br><span class="line">        .collect(maxBy(Map.Entry.comparingByValue()))</span><br><span class="line">        .map(Map.Entry::getKey)</span><br><span class="line">        .ifPresent(System.out::println);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//按照用户名分组，选用户下的总金额最大的订单</span></span><br><span class="line">orders.stream().collect(groupingBy(Order::getCustomerName, collectingAndThen(maxBy(comparingDouble(Order::getTotalPrice)), Optional::get)))</span><br><span class="line">        .forEach((k, v) -&gt; System.out.println(k + <span class="string">"#"</span> + v.getTotalPrice() + <span class="string">"@"</span> + v.getPlacedAt()));</span><br><span class="line"> </span><br><span class="line"><span class="comment">//根据下单年月分组，统计订单ID列表</span></span><br><span class="line">System.out.println(orders.stream().collect</span><br><span class="line">        (groupingBy(order -&gt; order.getPlacedAt().format(DateTimeFormatter.ofPattern(<span class="string">"yyyyMM"</span>)),</span><br><span class="line">                mapping(order -&gt; order.getId(), toList()))));</span><br><span class="line"> </span><br><span class="line"><span class="comment">//根据下单年月+用户名两次分组，统计订单ID列表</span></span><br><span class="line">System.out.println(orders.stream().collect</span><br><span class="line">        (groupingBy(order -&gt; order.getPlacedAt().format(DateTimeFormatter.ofPattern(<span class="string">"yyyyMM"</span>)),</span><br><span class="line">                groupingBy(order -&gt; order.getCustomerName(),</span><br><span class="line">                        mapping(order -&gt; order.getId(), toList())))));</span><br></pre></td></tr></table></figure>
<h3 id="partitionBy"><a href="#partitionBy" class="headerlink" title="partitionBy"></a>partitionBy</h3><p>partitioningBy 用于分区，分区是特殊的分组，只有 true 和 false 两组。比如，把用户按照是否下单进行分区，给 partitioningBy 方法传入一个 Predicate 作为数据分区的区分，输出是 Map&lt;boolean, list<T>&gt;;<br>partitioningBy 配合 anyMatch，可以把用户分为下过订单和没下过订单两组：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据是否有下单记录进行分区</span></span><br><span class="line">System.out.println(Customer.getData().stream().collect(</span><br><span class="line">        partitioningBy(customer -&gt; orders.stream().mapToLong(Order::getCustomerId)</span><br><span class="line">                .anyMatch(id -&gt; id == customer.getId()))));</span><br></pre></td></tr></table></figure>
<h2 id="三、一些思考"><a href="#三、一些思考" class="headerlink" title="三、一些思考"></a>三、一些思考</h2><p>1、以下两个操作的性能比较？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//计算所有订单商品数量</span></span><br><span class="line"><span class="comment">//通过两次遍历实现</span></span><br><span class="line">LongAdder longAdder = <span class="keyword">new</span> LongAdder();</span><br><span class="line">orders.stream().forEach(order -&gt;</span><br><span class="line">        order.getOrderItemList().forEach(orderItem -&gt; longAdder.add(orderItem.getProductQuantity())));</span><br><span class="line"> </span><br><span class="line"><span class="comment">//使用两次mapToLong+sum方法实现</span></span><br><span class="line">orders.stream()</span><br><span class="line">        .mapToLong(order -&gt; order.getOrderItemList().stream().mapToLong(OrderItem::getProductQuantity).sum())</span><br><span class="line">        .sum();</span><br></pre></td></tr></table></figure>
<p>2、如果仅有2条数据，skip跳过两条后取数据如果取不到会报错嘛？<br>例子如下，order会生成10条数据，这里直接跳过20条，结果为[]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; results = orders.stream()</span><br><span class="line">                .sorted(comparing(Order::getPlacedAt))</span><br><span class="line">                .map(order -&gt; order.getCustomerName() + <span class="string">"@"</span> + order.getPlacedAt())</span><br><span class="line">                .skip(<span class="number">20</span>).limit(<span class="number">2</span>).collect(toList());</span><br><span class="line">System.out.println(results);<span class="comment">// []</span></span><br></pre></td></tr></table></figure>

<p>3、关于distinct去重，是否可以对有相同属性内容的不同对象去重?<br>写了个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 产品2</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> LiuZiyu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/03/18 18:21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Product2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Double price;</span><br><span class="line">    <span class="keyword">private</span> Product product;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Product2 product1 = <span class="keyword">new</span> Product2(<span class="number">1L</span>, <span class="string">"橘子"</span>, <span class="number">33.0</span>, <span class="keyword">new</span> Product(<span class="number">1L</span>, <span class="string">"橘子"</span>, <span class="number">33.0</span>));</span><br><span class="line">    Product2 product2 = <span class="keyword">new</span> Product2(<span class="number">1L</span>, <span class="string">"橘子"</span>, <span class="number">33.0</span>, <span class="keyword">new</span> Product(<span class="number">1L</span>, <span class="string">"橘子"</span>, <span class="number">33.0</span>));<span class="comment">// 和第一条内容一致</span></span><br><span class="line">    Product2 product3 = <span class="keyword">new</span> Product2(<span class="number">2L</span>, <span class="string">"香蕉"</span>, <span class="number">33.0</span>, <span class="keyword">new</span> Product(<span class="number">1L</span>, <span class="string">"橘子"</span>, <span class="number">33.0</span>));</span><br><span class="line">    Product2 product4 = <span class="keyword">new</span> Product2(<span class="number">3L</span>, <span class="string">"苹果"</span>, <span class="number">33.0</span>, <span class="keyword">new</span> Product(<span class="number">1L</span>, <span class="string">"橘子"</span>, <span class="number">33.0</span>));</span><br><span class="line">    Product2 product5 = <span class="keyword">new</span> Product2(<span class="number">4L</span>, <span class="string">"樱桃"</span>, <span class="number">33.0</span>, <span class="keyword">new</span> Product(<span class="number">1L</span>, <span class="string">"橘子"</span>, <span class="number">33.0</span>));</span><br><span class="line"> </span><br><span class="line">    List&lt;Product2&gt; list = Lists.newArrayList();</span><br><span class="line">    list.add(product1);</span><br><span class="line">    list.add(product2);</span><br><span class="line">    list.add(product3);</span><br><span class="line">    list.add(product4);</span><br><span class="line">    list.add(product5);</span><br><span class="line"> </span><br><span class="line">    List&lt;Product2&gt; distinctList = list.stream().distinct().collect(toList());</span><br><span class="line">    System.out.println(JsonUtil.toString(distinctList));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：相同属性内容的对象可以进行去重</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;<span class="attr">"id"</span>:<span class="number">1</span>,<span class="attr">"name"</span>:<span class="string">"橘子"</span>,<span class="attr">"price"</span>:<span class="number">33.0</span>,<span class="attr">"product"</span>:&#123;<span class="attr">"id"</span>:<span class="number">1</span>,<span class="attr">"name"</span>:<span class="string">"橘子"</span>,<span class="attr">"price"</span>:<span class="number">33.0</span>&#125;&#125;,&#123;<span class="attr">"id"</span>:<span class="number">2</span>,<span class="attr">"name"</span>:<span class="string">"香蕉"</span>,<span class="attr">"price"</span>:<span class="number">33.0</span>,<span class="attr">"product"</span>:&#123;<span class="attr">"id"</span>:<span class="number">1</span>,<span class="attr">"name"</span>:<span class="string">"橘子"</span>,<span class="attr">"price"</span>:<span class="number">33.0</span>&#125;&#125;,&#123;<span class="attr">"id"</span>:<span class="number">3</span>,<span class="attr">"name"</span>:<span class="string">"苹果"</span>,<span class="attr">"price"</span>:<span class="number">33.0</span>,<span class="attr">"product"</span>:&#123;<span class="attr">"id"</span>:<span class="number">1</span>,<span class="attr">"name"</span>:<span class="string">"橘子"</span>,<span class="attr">"price"</span>:<span class="number">33.0</span>&#125;&#125;,&#123;<span class="attr">"id"</span>:<span class="number">4</span>,<span class="attr">"name"</span>:<span class="string">"樱桃"</span>,<span class="attr">"price"</span>:<span class="number">33.0</span>,<span class="attr">"product"</span>:&#123;<span class="attr">"id"</span>:<span class="number">1</span>,<span class="attr">"name"</span>:<span class="string">"橘子"</span>,<span class="attr">"price"</span>:<span class="number">33.0</span>&#125;&#125;]</span><br></pre></td></tr></table></figure>

<p>但是！如果把实体类的@Data去掉就不能去重了<br>为啥呢？<br>我们知道distinct判重使用的Object.equals方法，默认情况下，equals比较的是两个对象的引用地址是否相同，对象的地址不同就不可能去重，能够去重是因为@Data重写了equals方法，这个方法会比较对象的属性是否相等，所以才能去重成功。（@Data是Lombok库中的一个注解，用于自动生成Java类的getter、setter、equals()、hashCode()、toString()等方法。如果我们在一个类上使用了@Data注解，equals()方法会自动生成并比较所有的字段，而不是比较对象的引用是否相等）</p>
<p>但是还需要注意，如果在派生子类上用@Data注解，会有个提示：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/564594/1679468050700-fa5fa73d-902c-4016-afb3-990890a32b59.png#averageHue=%23474c4f&clientId=u87e9785a-e0b7-4&from=ui&id=u26678f6b&name=image2023-3-21_11-27-2.png&originHeight=215&originWidth=654&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=21829&status=done&style=none&taskId=u68cfd75a-db02-423c-acfb-caaf2baee76&title=" alt="image2023-3-21_11-27-2.png"><br>大致意思是默认重写生成子类的equals和hashCode方法，不会包含或者考虑父类的属性。如果这是我们想要的操作，建议加上@EqualsAndHashCode(callSuper = false)注解。<br>也就是说，用@EqualsAndHashCode(callSuper = false)时，在用equals比较时仅会比较子类的内容是否相同，不会管父类是否一致，如果改成@EqualsAndHashCode(callSuper = true),在比较时就会连同父类属性一起比较。可以参考这篇：<a href="https://juejin.cn/post/7055571573050179620" target="_blank" rel="noopener">https://juejin.cn/post/7055571573050179620</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2023/03/23/Java8%20Stream%E6%B5%81%E6%93%8D%E4%BD%9C%E6%80%BB%E7%BB%93/" data-id="clfkizvcy0000o4vbfr7eduvc" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-幂等性" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/07/11/%E5%B9%82%E7%AD%89%E6%80%A7/" class="article-date">
  <time datetime="2022-07-11T08:56:44.000Z" itemprop="datePublished">2022-07-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/07/11/%E5%B9%82%E7%AD%89%E6%80%A7/">幂等性</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="什么是幂等性"><a href="#什么是幂等性" class="headerlink" title="什么是幂等性"></a>什么是幂等性</h2><p>保证幂等性就是保证同一个请求，不论请求多少次，对资源的作用都是一样的（不是结果一样），也就是保证结果的唯一性。用数学的语言来表达就是：f(x) = f(f(x))。比如，求绝对值的函数，abs(x) = abs(abs(x))。<br>例如这样的一个场景，A系统请求B系统接口创建单据，由于网络超时或者其他可能原因，<br>1、A系统的请求可能还没到达B系统就丢失了<br>2、或者B系统已经收到B系统的请求并且已经创建了单据，但是A系统没有收到B系统的响应结果<br>A系统进行重试的时候，如果是第2种情况，那B系统就有可能再次重复创建单据，这个时候，就对B系统产生了不一样的作用，正常情况下，同一个单据只会创建一次，而由于上述的原因，同一个单据重复创建了两次，说明这个接口需要做幂等性校验。</p>
<h2 id="如何实现幂等性"><a href="#如何实现幂等性" class="headerlink" title="如何实现幂等性"></a>如何实现幂等性</h2><ol>
<li>全局ID（SnowFlake）</li>
</ol>
<p>每次A系统调用B系统时传一个全局唯一ID，B系统先看是否已有这个全局唯一ID，如果有，说明已经创建了，不需要再次创建。A系统重试时要保证是同一个全局ID。</p>
<ol start="2">
<li>先通过分布式锁防止并发，再select、insert保证幂等</li>
</ol>
<p>A系统的请求过来以后，B系统先去select是否已有，如果没有再insert，如果有则不做处理，也能保证幂等性，但如果有并发的问题，比如当A系统同时有两个请求过来（比如用户连续点击两次这样的情况），第一个请求还没有insert，第二个请求接着来了，B系统select后发现没有也会进行insert，然后就会insert两条重复数据。所以需要前置条件就是防止并发。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2022/07/11/%E5%B9%82%E7%AD%89%E6%80%A7/" data-id="clfkizvdy000io4vbga9ift0e" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-《世界尽头的咖啡馆》" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/12/20/%E3%80%8A%E4%B8%96%E7%95%8C%E5%B0%BD%E5%A4%B4%E7%9A%84%E5%92%96%E5%95%A1%E9%A6%86%E3%80%8B/" class="article-date">
  <time datetime="2021-12-20T09:47:12.000Z" itemprop="datePublished">2021-12-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/12/20/%E3%80%8A%E4%B8%96%E7%95%8C%E5%B0%BD%E5%A4%B4%E7%9A%84%E5%92%96%E5%95%A1%E9%A6%86%E3%80%8B/">《世界尽头的咖啡馆》</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>“有一天，我们坐在一段漂流木上，吃着新鲜的芒果，看着海浪冲上美得不可思议的海滩。我们在接近30摄氏度的水中玩人体冲浪，玩一个下午。日落时分，我们心情很放松，看着天空从明亮的蓝色变成粉红、橘红，再到正红。”</p>
</blockquote>
<hr>
<p>想象自己置身于美得不可思议的海滩上，看着天空从明亮的蓝色变成粉红、橘红，再到正红。<br />​<br /><br><a name="YcrxQ"></a></p>
<h3 id="你为什么来这里？"><a href="#你为什么来这里？" class="headerlink" title="你为什么来这里？"></a>你为什么来这里？</h3><p>因为我不满足，想找出真正令人满足和幸福的事物，也就是自己为什么存在。<br />对我来说，最难的在于如何找到自己真正喜欢的事物，以此才能知道自己存在的意义，书中给了一些指引。</p>
<blockquote>
<p>“所以，你的意思是说，人不能刚迈出第一步，就站在原地等待。如果有人真想知道他为什么存在，他就得为自己找出答案。”</p>
</blockquote>
<blockquote>
<p>“体验不同的事物，接触不同的理念，留意自己对各种事物的反应，这些都有助于我们寻找答案。”</p>
</blockquote>
<p><a name="Vi4Qm"></a></p>
<h3 id="你害怕死亡吗？"><a href="#你害怕死亡吗？" class="headerlink" title="你害怕死亡吗？"></a>你害怕死亡吗？</h3><p>害怕死亡的来临是因为还有很多想做的事没有做。</p>
<blockquote>
<p>“如果你已经做成想做的事，或者每天都在做想做的事，那就没理由害怕失去做这些事的机会。”</p>
</blockquote>
<p><a name="qz8Sb"></a></p>
<h3 id="你满足吗？"><a href="#你满足吗？" class="headerlink" title="你满足吗？"></a>你满足吗？</h3><blockquote>
<p>“只有当你弄清自己为什么存在，并且开始为这个存在意义做出实际努力后，你才能感到满足。”</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/12/20/%E3%80%8A%E4%B8%96%E7%95%8C%E5%B0%BD%E5%A4%B4%E7%9A%84%E5%92%96%E5%95%A1%E9%A6%86%E3%80%8B/" data-id="clfkizvdu000co4vb9q9xfq8r" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-重新出发" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/18/%E9%87%8D%E6%96%B0%E5%87%BA%E5%8F%91/" class="article-date">
  <time datetime="2021-10-18T02:51:43.000Z" itemprop="datePublished">2021-10-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/18/%E9%87%8D%E6%96%B0%E5%87%BA%E5%8F%91/">重新出发</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>总是希望生活有点波澜。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/10/18/%E9%87%8D%E6%96%B0%E5%87%BA%E5%8F%91/" data-id="clfkizve0000ko4vbhl1ee74c" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-早上好" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/12/%E6%97%A9%E4%B8%8A%E5%A5%BD/" class="article-date">
  <time datetime="2021-10-12T01:44:48.000Z" itemprop="datePublished">2021-10-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/12/%E6%97%A9%E4%B8%8A%E5%A5%BD/">早上好</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天阳光很好，是不是？</p>
<p>这两天有一种即将可以掌控自己生活的感觉，语言匮乏，不知道怎么准确描述这种感觉，总之，有什么东西在心中要破茧而出，这是比较关键的时间段，两种结果：一是破解而出，获得对自己生活的掌控感；二是那个东西消失，至于消失会带来什么我还不能感知。总之，我期望自己变得更年轻，有更多的好奇心，不断尝试新事物，找到自己真正喜欢的事。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/10/12/%E6%97%A9%E4%B8%8A%E5%A5%BD/" data-id="clfkizvdx000go4vbfgws1irt" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-《局外人》" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/11/%E3%80%8A%E5%B1%80%E5%A4%96%E4%BA%BA%E3%80%8B/" class="article-date">
  <time datetime="2021-10-11T08:11:57.000Z" itemprop="datePublished">2021-10-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/11/%E3%80%8A%E5%B1%80%E5%A4%96%E4%BA%BA%E3%80%8B/">《局外人》</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>刚开始读《西西弗神话》时，也许是对很多哲学概念都不了解再加上翻译的问题吧，觉得里面的内容晦涩难懂，偶然看到书后面有一个导读—-在荒诞中弃绝希望，挺身反抗。第一部分介绍背景、体裁与前期准备中，说到：</p>
<blockquote>
<p>在1941年2月21日的一则笔记中，加缪这样写道：“完笔西西弗。三荒诞完成。自由之发端。”</p>
</blockquote>
<p>所谓三荒诞指小说《局外人》、戏剧《卡里古拉》以及随笔《西西弗神话》。</p>
<blockquote>
<p>在加缪的构思中，“三荒诞”其实从属于“一部作品”，三者密不可分，因此加缪希望三者能够被读者同时了解，</p>
</blockquote>
<p>所以我去读了《局外人》，大学某个暑假时读过一次，给我的感觉是主人公的性格有点像村上所喜爱的主人公性格，我也觉得他的性格没什么问题，但故事情节没有太懂。<br>这次再读这本书，发现故事情节其实很好懂，但是这次不怎么喜欢主人公的性格，因为这次我除了把自己代入主人公本身，也通过那些其他身份的角色看待主人公，发现其实在真实生活中，确实没有太多人会喜欢这样的人，因为大家看不到这样的人的内心到底是怎样的。书中主人公的自我内心描述非常多，但是真实生活中没人会看到一个人最真实的内心，当我站在一个和主人公仅有几面之缘的人的角度来看，大概也是愤怒的希望他上断头台吧。但是即使这样看起来孤僻的人，也有喜欢他的女友（而且她的女友也正是被他的这样特别的性格所吸引，即使他妈妈下葬的第二天就和她一起去看电影做爱），也有希望和他做兄弟的人。<br>我认为主人公非常尊重自己的内心，但也是因为他太真实，最终被审判一死。他追求自由，追求真实，他明白人终有一死，所以对什么都无所谓，女友问他希望和她结婚吗，他说都可以，只要你想我们就可以结婚，女友问他如果是别人，也会这样爱别人嘛，他说显而易见会。朋友问他可以和他做兄弟嘛，他说都行….<br>似乎他从未对什么有些许期待和希望，而无视希望，也正是对荒诞的反抗。<br>​</p>
<p>以上是我自己的理解，这本书给我的感觉不是很好，也许再过几年，经历的事情多点以后再读，会有新的不同的感受。</p>
<p>补充：对抗世界的荒诞，可以像西西弗那样享受推石上山的过程，我的理解是活在当下，也如罗曼罗兰说的世界上的英雄主义，明白生活的真相也能继续热爱生活。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/10/11/%E3%80%8A%E5%B1%80%E5%A4%96%E4%BA%BA%E3%80%8B/" data-id="clfkizvdv000eo4vb6zz95phs" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-GIT分支管理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/11/GIT%E5%88%86%E6%94%AF%E7%AE%A1%E7%90%86/" class="article-date">
  <time datetime="2021-10-11T02:10:26.000Z" itemprop="datePublished">2021-10-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/11/GIT%E5%88%86%E6%94%AF%E7%AE%A1%E7%90%86/">GIT分支管理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="创建分支"><a href="#创建分支" class="headerlink" title="创建分支"></a>创建分支</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch 会列出所有分支，当前分支前会有一个*</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git branch dev 创建一个分支名为dev</span><br><span class="line">git checkout dev 切换到dev分支</span><br></pre></td></tr></table></figure>
<p>上面的两条命令可以合并为 一条</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b dev</span><br></pre></td></tr></table></figure>
<p>实际上，切换分支用<code>switch</code>更科学，因此，GIT提供新的<code>git switch</code>命令来切换分支</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git switch -c dev 创建并切换到新的分支</span><br><span class="line"></span><br><span class="line">git switch master 切换到已有分支</span><br></pre></td></tr></table></figure>
<h3 id="合并分支"><a href="#合并分支" class="headerlink" title="合并分支"></a>合并分支</h3><p>在<code>dev</code>分支上提交后，切换到<code>master</code>分支，把<code>dev</code>分支合并到<code>master</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge dev 合并指定分支到当前分支</span><br></pre></td></tr></table></figure>
<h3 id="删除分支"><a href="#删除分支" class="headerlink" title="删除分支"></a>删除分支</h3><p>合并完成后，可以放心删除分支了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git branch -d dev </span><br><span class="line"></span><br><span class="line">git branch -D dev 强制删除</span><br><span class="line"></span><br><span class="line">git push origin --delete dev  删除远程分支</span><br></pre></td></tr></table></figure>
<h3 id="分支管理策略"><a href="#分支管理策略" class="headerlink" title="分支管理策略"></a>分支管理策略</h3><p>通常合并分支时，GIT会用<code>Fast forward</code>模式，但是这种模式下，删除分支后，会丢掉分支信息。如果要强制禁用<code>Fast forward</code>模式，Git就会在merge时生成一个新的<code>commit</code>，这样，从分支历史上就可以看出分支信息。<br>合并<code>dev</code>分支时，用<code>--no-ff</code>参数表示禁用<code>Fast forword</code>模式<br>因为本次合并要创建一个新的commit，所以加上-m参数，把commit描述写进去。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge --no-ff -m &quot;merge with no--ff&quot; dev</span><br></pre></td></tr></table></figure>
<p>合并后，用<code>git log</code>查看分支历史</p>
<h3 id="储藏当前工作"><a href="#储藏当前工作" class="headerlink" title="储藏当前工作"></a>储藏当前工作</h3><p>场景：当工作进行到一半，突然有个bug需要紧急修复，但是当前工作没办法提交，就可以用GIT提供的<code>stash</code>功能，把当前工作现场先存储起来。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git stash</span><br></pre></td></tr></table></figure>
<p>用<code>git status</code>查看工作区是干净的，就可以放心创建分支修复bug。<br>修复完后，<code>git switch dev</code>切换到dev分支，可以用<code>git stash list</code>命令查看之前存的工作现场。然后进行恢复。<br>两种方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git stash apply</span><br><span class="line">此命令恢复后，stash内容并没有删除，需要用git stash drop删除</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git stash pop</span><br><span class="line">此命令恢复的同时会将stash内容一同删除</span><br></pre></td></tr></table></figure>
<h3 id="复制特定提交到另一个分支"><a href="#复制特定提交到另一个分支" class="headerlink" title="复制特定提交到另一个分支"></a>复制特定提交到另一个分支</h3><p>我们只想复制<code>4c805e2 fix bug 101</code>这个提交所做的修改，并不是把整个master分支merge过来。<br>为了方便操作，Git专门提供了一个<code>cherry-pick</code>命令，让我们能复制一个特定的提交到当前分支：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git cherry-pick 4c8052e</span><br></pre></td></tr></table></figure>
<h3 id="Feature分支"><a href="#Feature分支" class="headerlink" title="Feature分支"></a>Feature分支</h3><p>开发一个新feature，最好新建一个分支；<br>如果要丢弃一个没有被合并过的分支，可以通过<code>git branch -D &lt;name&gt;</code>强行删除。</p>
<p>参考：<a href="https://www.liaoxuefeng.com/wiki/896043488029600" target="_blank" rel="noopener">https://www.liaoxuefeng.com/wiki/896043488029600</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/10/11/GIT%E5%88%86%E6%94%AF%E7%AE%A1%E7%90%86/" data-id="clfkizvdd0002o4vb0onpeack" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-GIT时光穿梭" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/09/28/GIT%E6%97%B6%E5%85%89%E7%A9%BF%E6%A2%AD/" class="article-date">
  <time datetime="2021-09-28T07:19:43.000Z" itemprop="datePublished">2021-09-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/09/28/GIT%E6%97%B6%E5%85%89%E7%A9%BF%E6%A2%AD/">GIT时光穿梭</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="git-status"><a href="#git-status" class="headerlink" title="git status"></a><code>git status</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git status 帮助我们掌握仓库当前的状态</span><br></pre></td></tr></table></figure>
<h3 id="git-diff"><a href="#git-diff" class="headerlink" title="git diff"></a><code>git diff</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git diff 帮助我们查看具体的改动</span><br></pre></td></tr></table></figure>
<h3 id="git-log"><a href="#git-log" class="headerlink" title="git log"></a><code>git log</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git log 可以查看历史记录</span><br></pre></td></tr></table></figure>
<h3 id="git-reset-hard-HEAD"><a href="#git-reset-hard-HEAD" class="headerlink" title="git reset --hard HEAD^"></a><code>git reset --hard HEAD^</code></h3><p><code>HEAD</code>表示当前版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard HEAD^ 表示回退到上一个版本</span><br><span class="line">git reset --hard HEAD^^ 表示回退到上上个版本</span><br><span class="line">...</span><br><span class="line">git reset --hard HEAD~100 表示回退到前100个版本</span><br><span class="line">git reset --hard commit_id 表示到具体的某个版本（commit id表示版本号，是一个SHA1计算出来的一个非常大的数字，用十六进制表示）</span><br></pre></td></tr></table></figure>
<h3 id="git-reflog"><a href="#git-reflog" class="headerlink" title="git reflog"></a><code>git reflog</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reflog 查看历史命令</span><br></pre></td></tr></table></figure>
<h3 id="git的工作区和暂存区"><a href="#git的工作区和暂存区" class="headerlink" title="git的工作区和暂存区"></a>git的工作区和暂存区</h3><p>工作区就是能够看到的目录，工作区有一个隐藏目录<code>.git</code>，这个不算工作区，而是Git的版本库。版本库里存放了一个名为<code>stage</code>的暂存区，<br>还有<code>git</code>为我们创建的分支<code>master</code>，以及指向指向<code>master</code>的指针<code>HEAD</code></p>
<ol>
<li>在执行<code>git add</code>的命令时，就是将改动的文件放入暂存区</li>
<li>执行<code>git commit</code>后，会将暂存区的文件添加到当前分支</li>
</ol>
<h3 id="git的撤销和修改"><a href="#git的撤销和修改" class="headerlink" title="git的撤销和修改"></a>git的撤销和修改</h3><p>以下三个场景：</p>
<ol>
<li>想要撤销工作区的修改时，用命令<code>git checkout --file</code></li>
<li>当工作区的修改添加到了暂存区，但是想要撤销时，分两步 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> git reset HEAD &lt;file&gt; 用来撤销暂存区的修改（unstage）</span><br><span class="line">git checkout --file 撤销工作区的修改（实际上是用版本库中的版本替换工作区的版本）</span><br></pre></td></tr></table></figure></li>
<li>当修改已经提交到分支里了，但是没有推送到远程仓库，可以用<code>git reset --hard HEAD^</code> 回退到前一个版本</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/09/28/GIT%E6%97%B6%E5%85%89%E7%A9%BF%E6%A2%AD/" data-id="clfkizvdl0003o4vb79898lwu" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-去重" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/08/02/%E5%8E%BB%E9%87%8D/" class="article-date">
  <time datetime="2021-08-02T06:21:12.000Z" itemprop="datePublished">2021-08-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/08/02/%E5%8E%BB%E9%87%8D/">去重</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="利用TreeSet去重"><a href="#利用TreeSet去重" class="headerlink" title="利用TreeSet去重"></a>利用TreeSet去重</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 利用TreeSet去重</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> msgReceiverDTOList</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;MsgReceiverDTO&gt; <span class="title">distinctByTreeSet</span><span class="params">(List&lt;MsgReceiverDTO&gt; msgReceiverDTOList)</span> </span>&#123;</span><br><span class="line">    Set&lt;MsgReceiverDTO&gt; set = <span class="keyword">new</span> TreeSet&lt;&gt;((o1, o2)-&gt;o1.getEmployeeNumber().compareTo(o2.getEmployeeNumber()));</span><br><span class="line">    set.addAll(msgReceiverDTOList);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;MsgReceiverDTO&gt;(set);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="利用stream流去重"><a href="#利用stream流去重" class="headerlink" title="利用stream流去重"></a>利用stream流去重</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * java8 stream流</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> msgReceiverDTOList</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;MsgReceiverDTO&gt; <span class="title">distinctByStream</span><span class="params">(List&lt;MsgReceiverDTO&gt; msgReceiverDTOList)</span> </span>&#123;</span><br><span class="line">    List&lt;MsgReceiverDTO&gt; resultList = msgReceiverDTOList.stream().collect(</span><br><span class="line">            Collectors.collectingAndThen(</span><br><span class="line">                    Collectors.toCollection(() -&gt; <span class="keyword">new</span> TreeSet&lt;&gt;(Comparator.comparing(MsgReceiverDTO::getEmployeeNumber))), ArrayList::<span class="keyword">new</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> resultList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>collectingAndThen</code> 这个方法的意思是: 将收集的结果转换为另一种类型,因此上面的方法可以理解为,把 <code>new TreeSet&lt;&gt;(Comparator.comparingLong(BookInfoVo::getRecordId))</code>这个<code>set</code>转换为 <code>ArrayList</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/08/02/%E5%8E%BB%E9%87%8D/" data-id="clfkizvdw000fo4vb8aswelaz" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/03/23/ThreadPoolExecutor%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%8B%92%E7%BB%9D%E7%AD%96%E7%95%A5/">ThreadPoolExecutor的四种拒绝策略</a>
          </li>
        
          <li>
            <a href="/2023/03/23/Java8%20Stream%E6%B5%81%E6%93%8D%E4%BD%9C%E6%80%BB%E7%BB%93/">Java8 Stream流操作总结</a>
          </li>
        
          <li>
            <a href="/2022/07/11/%E5%B9%82%E7%AD%89%E6%80%A7/">幂等性</a>
          </li>
        
          <li>
            <a href="/2021/12/20/%E3%80%8A%E4%B8%96%E7%95%8C%E5%B0%BD%E5%A4%B4%E7%9A%84%E5%92%96%E5%95%A1%E9%A6%86%E3%80%8B/">《世界尽头的咖啡馆》</a>
          </li>
        
          <li>
            <a href="/2021/10/18/%E9%87%8D%E6%96%B0%E5%87%BA%E5%8F%91/">重新出发</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2023 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>